name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-adapter:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/adapter/requirements.txt
        
    - name: Run tests
      env:
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USER: neo4j
        NEO4J_PASSWORD: password
        GRAPHITI_URL: http://localhost:8000
        REDIS_URL: redis://localhost:6379/0
        LLM_BASE_URL: https://api.openai.com/v1
        LLM_API_KEY: sk-test
        LLM_MODEL: gpt-4o-mini
        EMBEDDING_BASE_URL: https://api.openai.com/v1
        EMBEDDING_API_KEY: sk-test
        EMBEDDING_MODEL: text-embedding-3-small
        RERANKER_BASE_URL: https://api.openai.com/v1
        RERANKER_API_KEY: sk-test
        RERANKER_MODEL: reranker-001
        ADAPTER_API_KEY: test-key
        JWT_SECRET: test-secret
        ADMIN_USERNAME: admin
        ADMIN_PASSWORD: password
      run: |
        cd backend/adapter
        python -m pytest

  build-docker:
    runs-on: ubuntu-latest
    needs: test-adapter
    steps:
    - uses: actions/checkout@v3
    
    - name: Build Adapter
      run: docker build -t graphiti-adapter backend/adapter
      
    - name: Build Worker
      # Worker context is root in our design now (or needs to be handled)
      # We need to make sure we build it correctly.
      # If we changed docker-compose to use root context, we should do same here.
      # For now, let's assume we copy the necessary files or use a proper build context.
      # I'll use the root context approach for the worker build command.
      run: docker build -f worker/Dockerfile -t graphiti-worker .
      
    - name: Build Frontend
      run: docker build -t graphiti-frontend frontend
